<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Attention !</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
		<style>
			html{
			background: #131516;
			color: #d8d4cf;
			}
			body{
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh;
			margin: 0;
			font-family:Helvetica,Arial,sans-serif
			}
			.container{
			width:230px;
			place-items: center;
			display: grid;
			transition:all .5s;
			position:relative
			}
			.disclaimer{
			margin-top: 30px;
			}
			.details{
			min-width: 90%;
			}
			.indexing{
			visibility:hidden
			}
			.bruteforcing{
			visibility:hidden
			}
			.solved{
			visibility:hidden
			}
			table{
			padding-left:20px;
			padding-right:20px
			}
			.w-full{
			text-align:left;
			width:100%
			}
			.blink span {
			opacity: 1;
			animation: blinker 1.2s linear infinite;
			}
			.blink span:nth-child(2) {
			animation-delay: 0.4s;
			}
			.blink span:nth-child(3) {
			animation-delay: 0.8s;
			}
			@keyframes blinker{
			50%{
			opacity:0
			}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<i class="fas fa-shield-alt fa-5x"></i>
			<div class="disclaimer blink">
				<a>Checking Your Browser </a><span>.</span><span>.</span><span>.</span>
			</div>
			<table class="details">
				<tr class="indexing">
					<td class="w-full">Indexing</td>
					<td id="index_res" class="blink"><span>.</span><span>.</span><span>.</span></td>
				</tr>
				<tr class="bruteforcing">
					<td class="w-full">Bruteforcing</td>
					<td id="brute_res" class="blink"><span>.</span><span>.</span><span>.</span></td>
				</tr>
				<tr class="solved">
					<td class="w-full">Reloading</td>
					<td class="blink"><span>.</span><span>.</span><span>.</span></td>
				</tr>
			</table>
		</div>
	</body>
	<script>
		const ip = "1.1.1.1"
		const challenge = "a33a38b9235d5b27a606234d60a44deb"
		const difficulty = 4
		const publicSalt = "CHANGE_ME"
		const indexing = document.getElementsByClassName("indexing")[0]
		const indexRes = document.getElementById("index_res")
		const bruteforcing = document.getElementsByClassName("bruteforcing")[0]
		const bruteRes = document.getElementById("brute_res")
		const solved = document.getElementsByClassName("solved")[0]

		let workerScript = `

			importScripts('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js');

			self.onmessage = function(e) { 
			
				function compareObj(obj1, obj2, iteration){
					if(iteration > 4){
						return true
					}
					for(let key in obj1){
						if(typeof obj1[key] == "function"){
							return true
						}
						if(typeof obj1[key] == "object"){
							compareObj(obj1[key], obj2[key], iteration + 1)
						} else {
							if(obj1[key] != obj2[key]){
								return false
							}
						}
					}
					return true
				}

				resp = {
					match: compareObj(navigator, e.data.navigator, 0),
					solution: "",
					access: ""
				}

				e.data.arr.forEach(string => {
					if(CryptoJS.MD5(e.data.ip+e.data.publicSalt+string) == e.data.challenge){
						resp.solution = string
						resp.access = CryptoJS.MD5(string+e.data.ip).toString()
						self.postMessage(resp)
					}
				})
			}
		`

		let possibleStrings = []

		function iterateStrings(currentString, length) {
			const alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';

			if (currentString.length === length) {
				possibleStrings.push(currentString)
				return;
			}

			for (let i = 0; i < alphabet.length; i++) {
				iterateStrings(currentString + alphabet[i], length);
			}
		}

		function spawnWorker(arr) {
			console.log("Spawned Worker")
			let blob = new Blob([workerScript], {
				type: 'text/javascript'
			});

			// Convert the Blob to a URL using URL.createObjectURL()
			var url = URL.createObjectURL(blob);

			// Create a new Worker using the Blob URL
			var worker = new Worker(url);

			// Listen for messages from the worker
			worker.onmessage = solved
			let workerMsg = {
				challenge: challenge,
				navigator: navigatorData,
				ip: ip,
				publicSalt: publicSalt,
				arr: arr
			}

			// Give the worker his array of strings to bruteforce
			worker.postMessage(workerMsg);
		}

		function divideArray(arr, parts) {
			let result = [];
			let len = arr.length;
			let partLen = Math.floor(len / parts);

			for (let i = 0; i < parts; i++) {
				let start = partLen * i;
				let end = i === parts - 1 ? len : start + partLen;

				result.push(arr.slice(start, end));
			}

			return result;
		}

		// A worker bruteforced it
		function solved(res) {
			if (res.data.match) {
				console.log("🥳 Heureka", res.data)
				bruteRes.children[0].innerHTML = "V"
		        bruteRes.classList.remove('blink')
		        bruteRes.children[1].remove()
		        bruteRes.children[1].remove()
		        solved.style.visibility = "visible"
				document.cookie = "POW-Solution=" + res.data.access + "; SameSite=Lax; path=/; Secure";
				window.location.reload()
			} else {
				console.log("🕵️ Something's wrong")
			}
		}

		function cloneObject(obj, iteration) {
			var clone = {};
			if (iteration > 4) {
				return clone
			}
			for (var i in obj) {
				if (typeof obj[i] == "object" && obj[i] != null && !(obj[i] instanceof Function))
					clone[i] = cloneObject(obj[i], iteration + 1);
				else if (typeof obj[i] !== 'function' && !(obj[i] instanceof HTMLElement))
					clone[i] = obj[i];
			}
			return clone;
		}

		// Clone navigator
		navigatorData = cloneObject(navigator, 0);

		// Calculate how many workers we can create
		let numWorkers = navigator.hardwareConcurrency
		if (numWorkers == undefined) {
			numWorkers = 2
		}
		if (numWorkers > 8) {
			numWorkers = 8
		}

		// Index every possible string
		iterateStrings("", difficulty)

		console.log("🥱 Indexed Strings")
		indexRes.children[0].innerHTML = "V"
		indexRes.classList.remove('blink')
		indexRes.children[1].remove()
		indexRes.children[1].remove()
		bruteforcing.style.visibility = "visible"

		let arrs = divideArray(possibleStrings, numWorkers)

		console.log("💪 Bruteforcing")

		arrs.forEach(arr => {
			spawnWorker(arr)
		})
		
		
	</script>
</html>
